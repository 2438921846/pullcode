# pullcode

pullcode是基于OpenAPI规范的封装了axios的typescript http请求客户端代码生成器。通过配置npm script命令即可直接将代码生成到指定目录下，直接使用。支持Swagger 2和OpenAPI 3(aka Swagger 3)。  

## 特性

1. 完全的typescript类型支持。依据Swagger2/OpenAPI3文档里的各接口路径前缀分组生成Service类，以及与RESTful接口一一对应的类方法，同时生成所有的对象类型的入参和出参的typescript类型。
2. 丰富实用的配置项。pullcode为用户封装好了axios配置项，可以优雅地传入自定义配置。
3. 内置了axios的request请求拦截器和response响应拦截器。请求拦截器已经做了请求地址的拼接和Authorization请求头的处理。响应拦截器已经做了从原始response中读取data属性的处理。用户可以通过配置项分别设置自定义的请求拦截器和响应拦截器作为补充。请求错误和响应错误的拦截器需要自定义实现和配置，生成器没有提供默认实现。
4. 前端框架无关（framework-agnostic）。无论采用何种前端框架，均可使用pullcode。

## 第三方依赖

* [commander.js](https://github.com/tj/commander.js)：nodejs命令行工具库
* [swagger2openapi](https://github.com/Mermade/oas-kit/blob/main/packages/swagger2openapi/README.md)：swagger 2 json文档转OpenAPI 3 json文档

## 安装

```shell
npm install --save pullcode
```

注意：pullcode生成的代码里依赖pullcode中的代码，pullcode既是一个命令行工具，也是一个npm模块，所以必须用`--save`，不能用`--save-dev`。

## 命令可选项

```shell
➜  pullcode git:(master) ✗ pullcode -h                                           
Usage: pullcode [options]

Options:
  -o, --output <value>  code output path
  -u, --url <value>     swagger 2.0 or openapi 3.0 json api document download url
  -h, --help            display help for command
```

* output: 指定代码生成到哪个文件夹，不存在的文件夹会自动递归创建

## 代码生成规则

生成代码时，pullcode首先会检查output目录里是否有BizService.ts文件，如果已经存在，则忽略，不会覆盖。其他文件无论是否已存在都会覆盖。

## 快速开始

1. 在package.json的scripts属性里配置pullcode命令，例如：

```javascript
"scripts": {
  "pull": "pullcode -u https://petstore3.swagger.io/api/v3/openapi.json -o src/api"
},
```

2. 执行命令`npm run pull`




使用方法
跟旧版本一样，生成的代码中只有BizService.ts文件可以修改，其他文件都不可修改。在使用之前需要在BizService.ts文件中做一些修改。先看一下生成的代码：
/**
* Generated by unionj-generator.
* You can edit it as your need.
*/
import { merge } from 'lodash-es';
import { CreateAxiosOptions, VAxios } from 'pullcode/src/httputil/Axios';
import { RequestOptions } from 'pullcode/src/types/axios';

const defaultOptions: CreateAxiosOptions = {
  requestOptions: {
    apiUrl: '', // same as baseUrl
    urlPrefix: '',
  } as RequestOptions,
}

export class BizService extends VAxios {
  constructor(options?: Partial<CreateAxiosOptions>) {
    super(merge(defaultOptions, options || {}));
  }
}

export default BizService;
我们只需要按实际需求修改defaultOptions对象：
1. 修改apiUrl。如果配置了用于解决跨域问题的proxy，这里的apiUrl只需设置成一个前缀即可。
2. 修改urlPrefix。这个参数需要跟后端同事确认接口是否有前缀。可能是后端接口的服务名，也可能没有前缀，保持空字符串即可。如果后端同事也不清楚有没有前缀或者不清楚请求url里哪部分是前缀，前端同事需自己调试接口判断。
3. 设置transform。就是设置自定义的axios拦截器。一般情况只需配置响应错误处理的拦截器。下文会给出示例代码。
4. 设置tokenGetter。这个参数是用来设置获取token的getter函数的。该函数会被request请求拦截器调用，并将返回的token放进header里。

修改后的代码示例如下：
/**
* Generated by unionj-generator.
* You can edit it as your need.
*/
import { merge } from 'lodash-es';
import { CreateAxiosOptions, VAxios } from 'pullcode/src/httputil/Axios';
import { useGlobSetting } from '/@/hooks/setting';
import { transform } from '/@/api/interceptor'
import { getToken } from '/@/utils/auth';
import { RequestOptions } from 'pullcode/src/types/axios';

const globSetting = useGlobSetting();

const defaultOptions: CreateAxiosOptions = {
  transform,
  requestOptions: {
    apiUrl: globSetting.apiUrl, // same as baseUrl
    urlPrefix: '/surveyworkbff',
  } as RequestOptions,
  tokenGetter: getToken as () => string
}

export class BizService extends VAxios {
  constructor(options?: Partial<CreateAxiosOptions>) {
    super(merge(defaultOptions, options || {}));
  }
}

export default BizService;

关于其他配置项，可自行查看CreateAxiosOptions类型定义。按上述步骤修改之后，就可以在vue组件中导入默认的Service实例调用接口了。

更多示例
响应错误处理
import type { AxiosResponse } from 'axios';
import type { AxiosTransform } from 'pullcode/src/httputil/axiosTransform';
import { checkStatus } from './checkStatus';
import { useMessage } from '/@/hooks/web/useMessage';
import { useErrorLogStoreWithOut } from '/@/store/modules/errorLog';
import { useI18n } from '/@/hooks/web/useI18n';

const { createMessage, createErrorModal } = useMessage();

/**
 * @description: 数据处理，方便区分多种处理方式
 */
export const transform: AxiosTransform = {
  /**
   * @description: 响应错误处理
   */
  responseInterceptorsCatch: (_: AxiosResponse, error: any) => {
    const { t } = useI18n();
    const errorLogStore = useErrorLogStoreWithOut();
    errorLogStore.addAjaxErrorInfo(error);
    const { response, code, message, config } = error || {};
    const errorMessageMode = config?.requestOptions?.errorMessageMode || 'none';
    const msg: string = response?.data?.error?.message ?? '';
    const err: string = error?.toString?.() ?? '';
    let errMessage = '';

    try {
      if (code === 'ECONNABORTED' && message.indexOf('timeout') !== -1) {
        errMessage = t('sys.api.apiTimeoutMessage');
      }
      if (err?.includes('Network Error')) {
        errMessage = t('sys.api.networkExceptionMsg');
      }

      if (errMessage) {
        if (errorMessageMode === 'modal') {
          createErrorModal({ title: t('sys.api.errorTip'), content: errMessage });
        } else if (errorMessageMode === 'message') {
          createMessage.error(errMessage);
        }
        return Promise.reject(error);
      }
    } catch (error) {
      throw new Error(error as unknown as string);
    }

    checkStatus(error?.response?.status, msg, errorMessageMode);
    return Promise.reject(error);
  },
};

调用接口
<script lang="ts">
...
// 引入默认实例，直接调用，无需new对象
import { samplemapService } from '/@/api/bff/SamplemapService';
import { protectService } from '/@/api/bff/ProtectService';

interface Option {
  label: string;
  value: string | number;
}

export default defineComponent({
  components: {
    BasicTable, TableAction, PageWrapper,
    [List.name]: List,
    [List.Item.name]: List.Item,
    AListItemMeta: List.Item.Meta,
    Icon,
  },
  setup() {
    const fatherRegionOptions = ref([] as Option[]);

    onBeforeMount(async () => {
      const regions: GetSamplemapRegionSubResp = await samplemapService.getSamplemapRegionSub({})
      regions.data.forEach((item: SamplemapFrameRegionVo) => {
        fatherRegionOptions.value.push({
          label: item.name,
          value: item.id,
        } as Option)
      })
    });

    ...
    const [registerTable, methods] = useTable({
      api: samplemapService.postSamplemapDataPage.bind(samplemapService),
      title: '数据管理',
      titleHelpMessage: ['可点击单元格编辑数据'],
      columns,
      rowKey: 'id',
      canResize: false,
      expandRowByClick: false,
      // showIndexColumn: false,
      actionColumn: {
        title: '操作',
        slots: { customRender: 'action' },
      },
    });

    async function handleDelete(record: SamplemapDataVo) {
      await protectService.deleteProtectSamplemapData({
        dataId: [record.id],
      })
      methods.reload()
    }

    function handleEditEnd({ record, index, key, value }: Recordable) {
      console.log(record, index, key, value);
      if (!value) {
        return
      }
      if (key === 'fatherRegionId') {
        record.regionName = undefined
        samplemapService.getSamplemapRegionSub({
          regionId: value,
        }).then((resp: GetSamplemapRegionSubResp) => {
          if (!resp.data || !resp.data.length) {
            protectService.putProtectSamplemapData({
              id: record.id,
              regionId: value,
            } as SamplemapDataUpdateVo)
          }
        })
      } else if (key === 'regionName') {
        protectService.putProtectSamplemapData({
          id: record.id,
          regionId: value,
        } as SamplemapDataUpdateVo)
      } else if (key === 'name') {
        protectService.putProtectSamplemapData({
          id: record.id,
          name: value,
        } as SamplemapDataUpdateVo)
      }
    }

    const tableSetting = {
    }

    const handleFileDelete = async ({ id }: SampleDataFile) => {
      await protectService.deleteProtectSamplemapFile({
        fileId: [id],
      })
      methods.reload()
    }

    const { apiUrl = '' } = useGlobSetting();

    const handleFetchSuccess = () => {
      methods.setProps({ columns, })
    }

    return {
      registerTable,
      handleDelete,
      handleEditEnd,
      tableSetting,
      handleFileDelete,
      apiUrl,
      handleFetchSuccess,
    };
  },
});
</script>

